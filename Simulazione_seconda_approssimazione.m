[ncd,dcd]=tfdata(Cd,'v');
ms=0.02;
g=9.81;
%%Trasduttore di Posizione
dati=[
  5.4000e+000  9.1970e+000
  5.3000e+000  9.1960e+000
  5.2000e+000  9.1870e+000
  5.1000e+000  9.1800e+000
  5.0000e+000  9.1750e+000
  4.9000e+000  9.1350e+000
  4.8000e+000  9.0900e+000
  4.7000e+000  9.0711e+000%
  4.6000e+000  9.0710e+000
  4.5000e+000  9.0690e+000
  4.4000e+000  9.0641e+000%
  4.3000e+000  9.0640e+000
  4.2000e+000  9.0630e+000
  4.1000e+000  9.0600e+000
  4.0000e+000  8.9930e+000
  3.9000e+000  8.6640e+000
  3.8000e+000  8.3440e+000
  3.7000e+000  8.2130e+000
  3.6000e+000  7.8650e+000
  3.5000e+000  7.3410e+000
  3.4000e+000  7.0090e+000
  3.3000e+000  6.7770e+000
  3.2000e+000  6.4020e+000
  3.1000e+000  5.7270e+000
  3.0000e+000  5.0110e+000
  2.9000e+000  4.4590e+000
  2.8000e+000  3.9530e+000
  2.7000e+000  3.1610e+000
  2.6000e+000  2.6790e+000
  2.5000e+000  2.0420e+000
  2.4000e+000  1.3350e+000
  2.3000e+000  6.6000e-001
  2.2100e+000  0
  2.1000e+000 -8.6900e-001
  2.0000e+000 -1.5510e+000
  1.9000e+000 -2.5380e+000
  1.8000e+000 -3.3720e+000
  1.7000e+000 -4.1900e+000
  1.6000e+000 -5.0230e+000
  1.5000e+000 -5.7500e+000
  1.4000e+000 -6.5250e+000
  1.3000e+000 -6.7880e+000
  1.2000e+000 -6.9940e+000
  1.1000e+000 -7.4300e+000
  1.0000e+000 -7.9280e+000
  9.0000e-001 -8.2050e+000
  8.0000e-001 -8.6020e+000
  7.0000e-001 -8.6350e+000
  6.0000e-001 -8.6451e+000%
  5.0000e-001 -8.6590e+000
  4.0000e-001 -8.6500e+000
  3.0000e-001 -8.6370e+000
  2.0000e-001 -8.6380e+000
  1.0000e-001 -8.6450e+000
            0 -8.6400e+000
];

% Posizione della sfera in m
z_ctp=dati(:,1)/100;

% Tensione del trasduttore in V
Vtrasdp_ctp=dati(:,2);
k=22;
N=19;
z0=0.0221;
Ktrasdp=[z_ctp(k+1:k+N)-z0]\Vtrasdp_ctp(k+1:k+N);

X=fminsearch('trasdp_min',[z0],[],Vtrasdp_ctp,z_ctp,z0);
zp=X(1);
cp=(Vtrasdp_ctp(1)+Vtrasdp_ctp(end))/2;
hp=Vtrasdp_ctp(1)-cp;
bp=abs(((hp/cp)^4-1)^(1/4)*(z0-zp));

%%Trasduttore di corrente
% Corrente nel magnete in A
Im_ctc=[
  8.2800e-002
  1.6580e-001
  2.4800e-001
  3.2800e-001
  4.1200e-001
  4.9200e-001
  5.7400e-001
  6.5200e-001
  7.3600e-001
  8.1400e-001
  8.9400e-001
  9.7600e-001
  1.0580e+000
  1.1380e+000
  1.2160e+000
  1.2980e+000
  1.3760e+000
  1.4540e+000
  1.5300e+000
  1.6100e+000
  1.6940e+000
  1.7850e+000
  1.8650e+000
  1.9450e+000
  2.0250e+000
  2.1100e+000
  2.1950e+000
  2.2725e+000
  2.3500e+000
  2.4400e+000
  2.5200e+000
  2.6000e+000
  2.6750e+000
  2.7550e+000
  2.8350e+000
  2.9150e+000
];
% Tensione del trasduttore di corrente in V
Vtrasdc_ctc=[
  2.0500e-001
  4.0700e-001
  6.0900e-001
  8.1200e-001
  1.0150e+000
  1.2170e+000
  1.4190e+000
  1.6210e+000
  1.8240e+000
  2.0260e+000
  2.2280e+000
  2.4310e+000
  2.6380e+000
  2.8410e+000
  3.0430e+000
  3.2460e+000
  3.4480e+000
  3.6510e+000
  3.8540e+000
  4.0570e+000
  4.2590e+000
  4.4620e+000
  4.6650e+000
  4.8680e+000
  5.0710e+000
  5.2830e+000
  5.4850e+000
  5.6890e+000
  5.8910e+000
  6.0940e+000
  6.2960e+000
  6.4990e+000
  6.7020e+000
  6.9050e+000
  7.1080e+000
  7.3100e+000
];
Ktrasdc=Im_ctc\Vtrasdc_ctc;
Im0=0.8;
Vtrasdc0=Im0*Ktrasdc;

%%Amplificatore di Transconduttanza
Vp_pwm=[6:.2:9]';
Im_pwm=[0.254  0.662 1.19 1.758 2.36 2.91 3.46 3.99 4.51 4.99 5.47 5.92 6.35 6.74 7.13 7.50]'/2.5;
% filtro di controllo
Ri=8200;
R1=68000;
C0=330e-12;
C1=1e-6;
numfc=1/(Ri*C1)*[R1*(C0+C1) 1];
denfc=[R1*C0 1 0];
p_pwm=polyfit(Vp_pwm,Im_pwm,1);

%%Elettromagnete
Vtrasdc_cm=[
   3.18000000000000
   3.08400000000000
   3.00000000000000
   2.82000000000000
   2.71000000000000
   2.55300000000000
   2.53600000000000
   2.50900000000000
   2.48800000000000
   2.42200000000000
   2.30600000000000
   2.27800000000000
   2.24900000000000
   2.19100000000000
   2.16300000000000
   2.11800000000000
   2.07500000000000
   2.03400000000000
   1.98000000000000
   1.93300000000000
   1.90000000000000
   1.87200000000000
   1.85000000000000
   1.82100000000000
   1.77300000000000
   1.74500000000000
   1.70200000000000
   1.66800000000000
   1.64900000000000
   1.62600000000000
   1.60500000000000
   1.58100000000000
   1.52500000000000
   1.50200000000000
   1.48000000000000
   1.45100000000000
   1.43100000000000
   1.41000000000000
   1.38700000000000
   1.35000000000000
   1.30400000000000
   1.27400000000000
   1.23400000000000
   1.20000000000000
   1.10300000000000
   0.96200000000000
   0.93800000000000
   0.89800000000000
   0.78900000000000
   0.77200000000000
];
Vtrasdp_cm=[
   6.20000000000000
   5.80000000000000
   5.47000000000000
   4.73000000000000
   4.28000000000000
   3.69000000000000
   3.54000000000000
   3.35000000000000
   3.17000000000000
   2.86500000000000
   2.40000000000000
   2.24000000000000
   2.08000000000000
   1.69000000000000
   1.51000000000000
   1.27000000000000
   1.05000000000000
   0.85000000000000
   0.56000000000000
   0.24500000000000
  -0.01500000000000
  -0.23000000000000
  -0.42000000000000
  -0.70000000000000
  -1.02000000000000
  -1.18000000000000
  -1.40000000000000
  -1.64000000000000
  -1.85000000000000
  -2.11000000000000
  -2.32000000000000
  -2.56000000000000
  -3.07000000000000
  -3.28000000000000
  -3.48000000000000
  -3.75000000000000
  -3.97000000000000
  -4.15000000000000
  -4.40000000000000
  -4.73000000000000
  -5.16000000000000
  -5.39000000000000
  -5.70000000000000
  -6.09000000000000
  -6.73000000000000
  -7.38000000000000
  -7.58000000000000
  -7.90000000000000
  -8.40000000000000
  -8.61000000000000
];
Im=Vtrasdc_cm/Ktrasdc;
z = interp1(Vtrasdp_ctp,z_ctp,Vtrasdp_cm);
X0=[0 0];
Xr=fminsearch('km_min2',X0,[],Im,z,ms,g);
Km2=Xr(1);
zcomp=Xr(2);

%%Attrito
t=[1.231 1.233 1.259 1.236];
tc=mean(t);
h=7.137;
Y=1;
tau=fminsearch('min_tau',Y,[],t,h,g);
beta=ms/tau;

%%Simulazione
Voffsetc2=sqrt(ms*g/Km2)*z0/.403;
sim('M2_1GDL');
%Output, riferimento e comando
figure();
plot(r.time,r.data,'r','Linewidth',1.5);
hold on;
plot(y.time,y.data,'b','Linewidth',1.5);
title('Step response'); xlabel('Time (s)'); ylabel ('r(t),y(t)'); legend('r(t)','y(t)'); grid on;
figure();
plot(u.time,u.data,'r','Linewidth',1.5); title('Control input'); xlabel('Time (s)'); ylabel('u(t)'); grid on;